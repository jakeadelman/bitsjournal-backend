#!/bin/sh
# linux/dynatrace-agent64.sh

if [ -n "$DT_HOME" ]; then
    dt_dir=`cd ${DT_HOME} && pwd -P`
elif [ -n "$BASH_VERSION" ] && [ "$0" != "$BASH_SOURCE" ]; then
    dt_script=$BASH_SOURCE
else
    dt_script=$0
fi

if [ -z "${dt_dir}" ]; then
    dt_dir_tmp=`readlink -f ${dt_script} 2>/dev/null`
    [ -n "${dt_dir_tmp}" ] && dt_dir=`dirname -- ${dt_dir_tmp} 2>/dev/null`
fi
if [ -z "${dt_dir}" ]; then
    dt_dir_tmp=`realpath ${dt_script} 2>/dev/null`
    [ -n "${dt_dir_tmp}" ] && dt_dir=`dirname -- ${dt_dir_tmp} 2>/dev/null`
fi
if [ -z "${dt_dir}" ]; then
    dt_dir_tmp=`dirname -- ${dt_script} 2>/dev/null`
    [ -n "${dt_dir_tmp}" ] && dt_dir=`cd ${dt_dir_tmp} && pwd -P`
fi
echo "Info: Using DT_HOME: ${dt_dir}"

dt_env="${dt_dir}/dynatrace-env.sh"
if [ -f "${dt_env}" ]; then
    . "${dt_env}"
else
    echo "Warning: Unable to find '${dt_env}'."
    echo "Info: Use DT_HOME to point to the Dynatrace installation directory."
fi

dt_agentpath="${dt_dir}/agent/lib64/liboneagentproc.so"
if [ -f "${dt_agentpath}" ]; then
    if [ -z "${LD_PRELOAD}" ]; then
        LD_PRELOAD="${dt_agentpath}"
    else
        LD_PRELOAD="${LD_PRELOAD}:${dt_agentpath}"
    fi
    export LD_PRELOAD
else
    echo "Warning: Unable to find '${dt_agentpath}'."
fi

if [ $# -gt 0 ] && [ `basename "$0"` = "dynatrace-agent64.sh" ]; then
    exec "$@"
fi
